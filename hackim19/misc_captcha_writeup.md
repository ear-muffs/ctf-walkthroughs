**CTF:** HackIM 2019 <br>
**CHALLENGE:** Captcha Forest

Prompt:
  `nc misc.ctf.nullcon.net 6001`

Ok I'll bite....Whatcha got? <br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;`Welcome to Captcha Forest`<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;`In order to get the flag, you must cut through 200 captcha trees.`<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;`I will send you captcha in png format (hex encoded), you must solve the captcha and give me correct answers to proceed further`<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;`Hint: I have used Bill Cipher mappings for captchas, good luck :)`<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;`--- press Enter to continue ---`

Upon pressing enter, hex-encoded PNG is sent.
<details>
<summary>Example:</summary>
  89504e470d0a1a0a0000000d49484452000000780000001b08020000003866dc7100000a9449444154789ced5a6d681cd51a3e0ec3388ec3b00ccb18d6614d9725c610b77591528b0d45625c6aa850a3a189b6125b62d13694257e856511c1b24890926a35b44dcca2550c7553db68fa414828fd54d18d6e42599265bb6ed771d84c2693e374329dde1fe73a7749b2b39336deeb8ffbfc089999f79df73dcf793fce39b377ddba750bfc1f7f3f703b42baae0b82a0aa2a49924ea7932088bfdbad3b443e9f6759f6f674755d57148520088aa256d0255b449f387162606040144596651f7becb14d9b36b9ddee15746265218ae2fefdfb77efdecd71dc6da8a7d3e9c3870fdf7ffffdf5f5f53ccf6318b6326edd2a852b57ae783c1e9224abaaaa2a2a2a5896ddb66ddbf4f47449c5ff152e5cb8e072b9060606d0e5fcfcfcf4f4f4cd9b376daa0f0d0d9124c9b26c5353d3c8c8c84a795582e83ffffc73cb962d344dbff6da6b232323c3c3c39b376fa628eae8d1a32be54149dcbc79f3e79f7f3e7dfab44df9b367cf721c17894490ee575f7df5fcf3cf7ffbedb7366d7df9e5972804711cf7fbfdd168f4c68d1bb7effd5f289117f178fcf2e5cb555555a150a8a6a666e3c68dcf3cf30c4110636363cbca9b743aad695ab1a7131313838383f97c7ec9a7aaaa9e3a75ea9b6fbe5155d58e2d5dd70100d7af5f070040084f9f3edddfdfffc9279fd8d4551405c7f1a6a6a64d9b362512898e8e8e70382c08821d750b94205a14454dd33c1e8f59ef1886c171fceebbefb66f239d4eb7b6b65ebc78b198403c1e8f46a3c506a3ebfaf5ebd745515414c58e395455d1b45114b575ebd6a6a6a6e6e6663bba8661288ac230cc534f3d158d46bbbaba64593e70e0c0ae5dbbe2f1b8611816baa3a3a3870e1d1245b1f06db1580c299620dae7f3711cf7fdf7dffff4d34f922489a278e1c20508e1b27aba244982208c8e8e1613906539994c4208977c6a18068410426833a2298ac2300c118d61d8c68d1ba3d1684343831d5dc3305455a5288aa669866176ecd8313c3cbc76eddaefbefb6eebd6adc78e1d2b36d98aa20c0d0df5f4f4e47239f3662e97fbecb3cfa2d1a8a2282588e6797ef7eeddf97cfec5175f0c85427bf7eeedebeb8310922469c76f044dd3745d9f9a9a2a268012d6a2b6a037580814a2acac8c2008411026262692c9642a95ca66b3f97cdea6baa669388e9b4bd8356bd6f4f4f4ecd8b14392a45dbb761d3870a0904a138aa264b35949920aa3419665499252a994a669a597772d2d2db95ceee4c993274e9cc8e7f3684a7ffdf557c3306c2e7d50c665b3590b010861b1c4340c03118d8a6f49f03c5f5d5d7deedcb9b6b63692244992a4288a6198071e7860ddba75ebd7afb776757e7e1ec7711cff0f336eb73b1c0e3ff4d043070f1e7ce79d77ae5dbbb673e74e9fcf57387c555511cb854e22b72549320ca334d1388ebffefaeb757575b95c4e14c5919191582c363838f8ecb3cf3efef8e376468e50acd781022a8b09e8ba6e18867589344110444747c7d1a347af5ebd9a4ea7655956140565cc962d5bd6ac5963bd13d1751dc3b00531c4b2ec4b2fbd545e5eded9d979e8d0a16432f9eaabafd6d6d69aafd2344d51940544239f5555b54534008024c975ebd621cdbaba3a8fc7f3de7bef75767696959579bd5e3b6f00964423472d221a116dd3100060fdfaf59595958220c8b2acaaaaaaaa9aa66ddfbe3d93c988a268bddb5a9268000049927575753ccf7774740c0e0ea652a94020f0e4934f7abd5e8ee3ccb95cec27ba638b68131886b9ddee603078f1e2c53367ce7cf1c5176fbef96661962d091cc7310c9365d942c68268f0d78a6d595cb32cbba063330c83e2ce420b4d6ab1a7188655575747221100c0f1e3c73399ccb163c7288a220842d3b44c26a3695a6b6b2b4dd3481e42984ea77d3e1f582ed108344d731ca769daececac1d7944b4f508ad4b87fdba61019aa6ad79346d59f71e8ee33c1e0f304315c7455134dbe0e4e4a4a98efa0a0ac465136d18c6b973e7fafbfb1f7df4d1c6c6c692e10cfe221ab5bb6263d034add8aac00e3b764092a49d12642d0021ecededfdf8e38f799e0f06832d2d2d0cc3288ad2dddd1d0e8701002fbcf0c2aa55ab90f0a54b978e1f3fee7038703b3421a0d595aaaabffcf2cbdebd7b49926c6e6ef6fbfd767411d10000b4172826a6288a39ff8baddbf4d3028aa250145572c816d993cfe73ffffcf38e8e0e97cb150c06b76ddb86aa044dd381406060602093c96cdfbe1df53300406f6fef99336758962d41b4aeebc964329148a4d36908e1dcdc9c2ccba3a3a3894482a66955554551743a9d254748922432644db42ccb16fdb0a495624380104a92944c2633994c555555c91d40315bd96cf6c891231f7cf081d7eb6d6f6f6f6868285cbd381c0eb7db0d212cbc49d33445511cc759119dcbe5fafbfb4f9e3c994824b2d9ec82989224a9b3b3737a7abab5b595e7796bd74da2655976b95cc5c44451d4757df161372a1df68f2b15453972e4c86fbffd86d61b1042599653a9148a68eb3d2d62797150a752a9aeaeaebebe3eb7dbbd6fdfbedadada05d45114e5743a5d2e97d90901000cc3381c8e55ab561104b134d18220ecdfbfbfb7b7d7e974d6d7d73ffcf0c32ccb9224897616a2288e8d8d9d3a75eaa38f3e0200b4b5b559c7b599b0d6fd706a6a4ad3b42517b94b4e4031288a72f0e0c1c9c949b322631846d3f4dab56b1b1b1b1d0e8785ae399d85444f4e4ebefbeebbb158cceff787c3e19a9a9ac58a344d6fd8b061f5ead5656565e64db7dbedf3f93c1ecfd211adebfaf9f3e7bbbbbbebebeb83c1a0dbed2e2c6d28be20848d8d8da150a8bbbb7bc3860db5b5b516114751144ad86030b8e49424934900402c168310ae5ebd9a61189aa6699a260882244945516459b653a34ca8aaeaf57adf7fff7d641abd8aa22887c3513233300c2bec99686f72fefcf94020100a85aaabab97d4c2713c1008a0c19a37bd5e6f2412615916c3b025885655f5d2a54b24493efdf4d3680db8c00f1cc749927ce28927ae5ebd1a0c061389444d4d8d45edc330acb2b2f2c71f7f8cc7e3a0203d4141e0204263b1582c165bcc85aeeb16356749783c9e40208061183a90030058b487c5e6d02a281e8f3ff7dc739224b5b4b4bcf5d65b85d1ba188b7311c7f1f2f2f27fffbf5801c7f1fbeebb4f96e5b1b1b1bababa62b926cbf2d4d41486613ccf976ce5a150a8b9b95910044551d0391cdaada1e5f3fcfc7ce1267bc15ff4cf830f3eb8ac2343a7d389262c93c9bcf1c61b388e1f3e7cd84efd21080242984aa5fafafac2e1308ee3ededed7bf6ec292cbeb783253f07fcf0c30f7ebfdfe572452291f1f1f1999999f9f979f31bc4ecececf8f878575797c7e3a9adad1d1f1fbff30f102b883ffef8a3bcbcfcedb7df469743434315151518865dbb76ada4eeecec2cdaeb7a3c1e87c3515959f9e9a79f9a63bf132c1d89959595edededfbf6ed8b4422c3c3c31515150cc3dc73cf3d00005dd76766662626262e5fbeccb2ecce9d3bcdecf8870055e4471e79045dfa7cbe975f7e796a6aca4ee9c030ecde7befd5753d9d4ed7d4d4b4b5b56ddebc7965dc2a360373737367cf9eddb3678fdfef3733ceac9e2ccb3634347cfdf5d7333333773edb2b8e0f3ffcf0f7df7f372fe7e6e66c7e4dbe71e3464f4f8fdbed7ee59557ae5cb9b222b18c70d7ade23fa0310c239fcfe772394110b2d9ac200810428220388eaba8a8e079dee572d9df5bfe37b160e3b02c0882904ea7799ee7386ec57e6b008015d18540e723e631ca3fff3734ff34fc0b97cc650d4ba33e670000000049454e44ae426082</details>

<br> I hadn't done programmatic interaction with a remote service since socket programming in a college networking class, but after some googling I started playing with Bash file descriptors and, before I knew it, I'd committed myself do doing this with a Bash script.

From here on, variations on the below three lines were all I needed to interact with the remote service. Respectively, they establish file descriptor 3 for read/write on the specified TCP/IP socket, retrieve a specified number of lines from the server's response using said file descriptor, and send messages to the service.<br>
- ```exec 3<>/dev/tcp/misc.ctf.nullcon.net/6001;```<br>
- ```head -5 <&3```<br>
- ```echo '\n' >&3;```<br>

Now it's time to solve some captchas! Decoding and viewing the above PNG (piping to ```xxd -r -p > out.png```) revealed the use of a static substitution cipher.

https://www.dcode.fr/gravity-falls-bill-cipher

&nbsp;&nbsp;&nbsp;&nbsp;![exampleCaptcha](captcha.png)

After checking a handful of captchas, I confirmed that they were all 4 "characters" long. By breaking the captcha into 4 separate images, I was able to create a lookup table with key:md5/value:alpha (i.e. Bash associative array) for automated captcha solving.

&nbsp;&nbsp;&nbsp;&nbsp;![firstCharCropped](cropped_0.png)<br>
&nbsp;&nbsp;&nbsp;&nbsp;![secondCharCropped](cropped_1.png)<br>
&nbsp;&nbsp;&nbsp;&nbsp;![thirdCharCropped](cropped_2.png)<br>
&nbsp;&nbsp;&nbsp;&nbsp;![fourthCharCropped](cropped_3.png)<br>

After creating and inserting the lookup table into the script, I was good to go!

Gotchas that tripped me up along the way:
- md5s of cropped PNGs weren't matching (maybe inconsistent metadata?), converting cropped images to JPGs fixed the issue
- network connectivity issues, didn't always receive expected message; should implement error handling
- couldn't ```head <&3``` on command line to dump the flag after script executed; monitored network comms in Wireshark and noticed the flag was sent right before a RST, thus the final counter check to print the flag (or just pull from Wireshark)

### Final Script:

```Bash
#!/bin/bash

declare -A lookup

lookup["6f7da0a17995c27f58cb29279eafef29"]=P
lookup["7555833af8345f3237634df486be223f"]=Q
lookup["12ce199447d38fa88f4c20c57eabb165"]=F
lookup["0ac16420b396a0673fdf6bfbd5aca883"]=R
lookup["1af8b625e2e8e5706d88147b565c7895"]=K
lookup["a79c161ae1f7057123d64801f5553eff"]=N
lookup["1eace9dcd6003025adbe56fea7d210b5"]=Z
lookup["cf3c8a23a5877a78feda7b3554c701f5"]=D
lookup["49f51936e99c639e40ab4457ab5bce79"]=T
lookup["c669be89d912d450759e63dba178f535"]=S
lookup["6ca8ba744c01cbcf56d9524f645c282d"]=C
lookup["54a8b3665a68f423a9b25e1652297b98"]=J
lookup["10355fa643d4414af9b9764aebc70156"]=Y
lookup["e50a5bb7419da3d6ac4f5bb011580b36"]=G
lookup["2fd562385519c750f198adc3c54dc543"]=M
lookup["918a73af76622dfc8c06913e3dd43fe4"]=L
lookup["5d0bb0db40904cfc731f1b3cf95db218"]=E
lookup["384fb968097f9ade9d21a6d8f4c32587"]=B
lookup["41d67db7e2e74f6d497245302ae16f7e"]=A
lookup["c79fd16f9c0dfdb36f0857ae4ae3163d"]=I
lookup["84009392fb815af1d24f3b9e40e8cf0c"]=O
lookup["59466838ecbdcc8449db6fb30370ce7a"]=V
lookup["fdb793a2f022d79d681e83ca496203a6"]=X
lookup["1f79ef5591a93b52c2ce7b744c1b6866"]=U
lookup["fde75115c4b61948a5eebf0664432fcd"]=W
lookup["bb84d293cb9ec98e3d83ae64fc2b77a9"]=H


exec 3<>/dev/tcp/misc.ctf.nullcon.net/6001;
head -5 <&3
echo '\n' >&3;

response=""

for i in {1..200} # loop through all 200 captchas...
do
	head -1 <&3 | xxd -r -p > out_$i.png
	convert -crop 30x27 out_$i.png cropped_$i_%d.png # break up image into individual characters

	for j in {0..3} # for each character in captcha...
	do
		convert cropped_$i_$j.png cropped_$i_$j.jpg # convert from png to jpg to get around hash issue
		md5=`md5sum cropped_$i_$j.jpg`
		md5=${md5:0:32} # grab only hash, exclude filename

		if [[ ${lookup[$md5]} == "" ]]; then # don't have value in lookup table
			eog cropped_$i_$j.jpg

			read -n 1 -p "Plaintext: " plaintext # read in plaintext from user
			echo ""
			lookup[$md5]=$plaintext; # store value in lookup table

			response+=$plaintext # append plaintext to response string
			echo "lookup[\""$md5"\"]="$plaintext >> lookuptable.txt # save off key/value, add anything new to start of file

		else # value exists in lookup table, append char to response
			response+=${lookup[$md5]}
		fi
	done

	echo "SENDING RESPONSE #" $i " WITH VALUE: "$response
	echo $response >&3
	head -2 <&3
	echo '\n' >&3

	if [ $i == 200 ]; then # on last iteration, print flag!
		echo `head <&3`
	fi
done```
